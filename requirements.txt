import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.preprocessing import StandardScaler
from sklearn.manifold import TSNE
from keras.models import Model
from keras.layers import Input, Dense
from sklearn.cluster import DBSCAN

# Charger les données
data = pd.read_csv("votre_fichier.csv")  # Remplacez "votre_fichier.csv" par le nom de votre fichier de données

# Standardiser les données
scaler = StandardScaler()
data_scaled = scaler.fit_transform(data)

# Appliquer t-SNE pour réduire à 2 dimensions
tsne = TSNE(n_components=2, random_state=42)
tsne_components = tsne.fit_transform(data_scaled)

# Créer un DataFrame pour les deux dimensions t-SNE
tsne_df = pd.DataFrame(data=tsne_components, columns=['Dimension 1', 'Dimension 2'])

# Définir l'architecture de l'autoencodeur
input_dim = data.shape[1]
encoding_dim = 32

input_layer = Input(shape=(input_dim,))
encoder = Dense(encoding_dim, activation='relu')(input_layer)
decoder = Dense(input_dim, activation='sigmoid')(encoder)

autoencoder = Model(input_layer, decoder)
autoencoder.compile(optimizer='adam', loss='mean_squared_error')

# Entraîner l'autoencodeur
autoencoder.fit(data_scaled, data_scaled, epochs=50, batch_size=64, shuffle=True, validation_split=0.2)

# Reconstruire les données avec l'autoencodeur
reconstructed_data = autoencoder.predict(data_scaled)

# Calculer la perte de reconstruction
reconstruction_error = np.mean(np.square(data_scaled - reconstructed_data), axis=1)

# Définir un seuil pour la détection d'anomalies avec l'autoencodeur
threshold_autoencoder = np.percentile(reconstruction_error, 95)

# Identifier les anomalies détectées par l'autoencodeur
anomalies_autoencoder = data[reconstruction_error > threshold_autoencoder]

# Créer un modèle DBSCAN
dbscan = DBSCAN(eps=0.5, min_samples=5)

# Prédire les clusters avec DBSCAN
clusters = dbscan.fit_predict(tsne_components)

# Identifier les anomalies comme les points ne faisant pas partie d'un cluster (cluster -1)
anomalies_dbscan = data[clusters == -1]

# Afficher les lignes qui sont des anomalies détectées par l'autoencodeur
print("Anomalies détectées par l'autoencodeur avec t-SNE :")
print(anomalies_autoencoder)

# Afficher les lignes qui sont des anomalies détectées par DBSCAN
print("Anomalies détectées par DBSCAN avec t-SNE :")
print(anomalies_dbscan)

# Visualisation des anomalies détectées par l'autoencodeur avec t-SNE
plt.figure(figsize=(10, 5))
plt.scatter(tsne_df['Dimension 1'], tsne_df['Dimension 2'], c=reconstruction_error, cmap='coolwarm', alpha=0.5)
plt.title('Anomalies détectées par l\'autoencodeur avec t-SNE')
plt.xlabel('Dimension 1 (t-SNE)')
plt.ylabel('Dimension 2 (t-SNE)')
plt.colorbar(label='Erreur de reconstruction')
plt.grid()
plt.show()

# Visualisation des anomalies détectées par DBSCAN avec t-SNE
plt.figure(figsize=(10, 5))
plt.scatter(tsne_df['Dimension 1'], tsne_df['Dimension 2'], c=clusters, cmap='coolwarm', alpha=0.5)
plt.title('Anomalies détectées par DBSCAN avec t-SNE')
plt.xlabel('Dimension 1 (t-SNE)')
plt.ylabel('Dimension 2 (t-SNE)')
plt.colorbar(label='Cluster')
plt.grid()
plt.show()
